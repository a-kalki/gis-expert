# План реализации: Backend на Bun.serve и Система Сборки

**Задача:** Заменить n8n на кастомный сервер на `bun.serve` и реализовать систему сборки фронтенда с учетом окружения и кэширования.

**Статусы:**
*   `[ ]` - Не начато
*   `[~]` - В процессе
*   `[x]` - Выполнено

---

### **Этап 1: Создание Bun.serve сервера (`src/server.ts`)**

*   `[x]` **1.1. Создать базовую структуру сервера.**
    *   **Действие:** Создать файл `src/server.ts` с минимальным `bun.serve` сервером.
*   `[x]` **1.2. Реализовать эндпоинт для аналитики (`/api/track`).**
    *   **Действие:** Добавить POST-эндпоинт `/api/track`, который будет принимать данные от `tracker.js` и сохранять их в таблицу `user_events`.
*   `[x]` **1.3. Реализовать эндпоинт для формы (`/api/submit-form`).**
    *   **Действие:** Добавить POST-эндпоинт `/api/submit-form`, который будет принимать данные от `form.html` и сохранять их в таблицу `form_submissions`.
*   `[x]` **1.4. Настроить CORS.**
    *   **Действие:** Добавить необходимые CORS-заголовки для разрешения запросов с `http://localhost:3000` (или другого порта сервера).

---

### **Этап 2: Настройка Системы Сборки (Frontend Build Process)**

*   `[x]` **2.1. Выбор инструмента сборки.**
    *   **Действие:** Использовать встроенный бандлер Bun для сборки HTML и JS.
*   `[x]` **2.2. Настройка сборки для разработки (`start:dev`).**
    *   **Действие:** Настроить скрипт `start:dev` для сборки фронтенда в режиме разработки (без минификации, с картами исходников).
    *   **Действие:** Настроить инъекцию переменных окружения (например, `API_BASE_URL`) в JS-файлы.
    *   **Действие:** Настроить вывод в отдельную папку (например, `dist/dev`).
*   `[x]` **2.3. Настройка сборки для продакшна (`start:prod`).**
    *   **Действие:** Настроить скрипт `start:prod` для сборки фронтенда в режиме продакшна (с минификацией, без карт исходников).
    *   **Действие:** Настроить инъекцию переменных окружения.
    *   **Действие:** Настроить вывод в отдельную папку (например, `dist/prod`).
    *   **Действие:** Реализовать добавление хэш-суффиксов к именам файлов для кэш-бастинга.

---

### **Этап 3: Модификация Frontend (Использование собранных файлов)**

*   `[x]` **3.1. Обновить URL вебхука в `src/tracker.js` (будет инжектироваться).**
    *   **Действие:** Изменить `webhookUrl` на переменную окружения, которая будет инжектироваться в процессе сборки.
*   `[ ]` **3.2. Обновить URL вебхука в `src/form.html` (будет инжектироваться).**
    *   **Действие:** Изменить `webhookUrl` на переменную окружения, которая будет инжектироваться в процессе сборки.
*   `[x]` **3.3. Обновить ссылки на JS-файлы в `index.html` и `form.html`.**
    *   **Действие:** Изменить ссылки на `main.js` и `tracker.js` на собранные версии с хэшами.

---

### **Этап 4: Настройка запуска сервера**

*   `[x]` **4.1. Добавить скрипты запуска сервера в `package.json`.**
    *   **Действие:** Добавить скрипты для запуска сервера (`bun run dev:server`, `bun run start:server`).
*   `[ ]` **4.2. Настроить запуск через PM2.**
    *   **Действие:** Предоставить инструкции по запуску сервера через `pm2` для продакшна.

---

### **Этап 5: Тестирование**

*   `[ ]` **5.1. Проверить сквозной процесс для аналитики.**
    *   **Действие:** Убедиться, что данные от `tracker.js` корректно сохраняются в `user_events`.
*   `[ ]` **5.2. Проверить сквозной процесс для формы.**
    *   **Действие:** Убедиться, что данные формы корректно сохраняются в `form_submissions`.