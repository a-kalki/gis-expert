# План рефакторинга: Переход на модульную архитектуру

**Дата:** 24.10.2025

**Цель:** Реорганизовать кодовую базу из монолитной структуры в модульную. Это повысит изоляцию компонентов, упростит масштабирование и подготовит проект к возможному разделению на микросервисы в будущем.

**Ключевая идея:** Проект будет разделен на три основных модуля:
1.  `app`: Ядро приложения, отвечающее за общую инфраструктуру (сервер, БД, общие UI-компоненты).
2.  `community`: Вертикальный модуль, содержащий всю логику, связанную с IT-сообществом.
3.  `course`: Вертикальный модуль, содержащий всю логику, связанную с курсами программирования.

---

## Целевая структура директорий

```
/src/
    ├── app/
    │   ├── server.ts
    │   ├── db.ts
    │   ├── migrations/
    │   ├── db-utils/
    │   └── ui/
    │       ├── common.css
    │       └── user-session-manager.ts
    │
    ├── community/
    │   ├── api/
    │   │   └── routes.ts
    │   ├── domain/
    │   │   └── ...
    │   └── ui/
    │       ├── index.html
    │       ├── index.css
    │       └── main.ts
    │
    └── course/
        ├── api/
        │   └── routes.ts
        ├── domain/
        │   ├── phone.ts
        │   └── phone.test.ts
        └── ui/
            ├── index.html
            ├── details.html
            ├── form.html
            └── ...
```

---

## План миграции

### Фаза 1: Создание структуры директорий

- [x] Создать корневые директории для модулей: `src/app`, `src/community`, `src/course`.
- [x] Создать внутреннюю структуру для каждого модуля: `api/`, `domain/`, `ui/` (где применимо).
- [x] Создать директории `src/app/migrations` и `src/app/db-utils`.

### Фаза 2: Миграция ядра приложения (модуль `app`)

- [x] **Переместить `src/api/server.ts` в `src/app/server.ts`**. Этот файл станет главной точкой входа для всего бэкенд-приложения, он будет оркестрировать запуск и подключение роутов из других модулей.
- [x] **Переместить `src/api/db.ts` в `src/app/db.ts`**. Подключение к базе данных — это общий ресурс, управляемый ядром.
- [x] **Переместить корневые директории `migrations/` и `db-utils/` в `src/app/`**. Управление схемой БД централизовано в ядре.
- [x] **Переместить `src/ui/user-session-manager.ts` в `src/app/ui/user-session-manager.ts`**. Этот скрипт является общей логикой, которая может использоваться на страницах всех модулей.
- [x] **Переместить `src/ui/index.css` в `src/app/ui/common.css`**. Предполагается, что основные стили будут общими.

### Фаза 3: Миграция модуля `course`

- [x] **Переместить все UI-файлы, специфичные для курсов, из `src/ui/` в `src/course/ui/`**. Сюда входят `index.html`, `details.html`, `form.html`, `tracker.ts`, `form-logic.ts`, `chat-manager.ts` и т.д.
- [x] **Переместить доменную логику курсов (`src/domain/phone.ts` и `phone.test.ts`) в `src/course/domain/`**. Эта логика специфична для формы заявки на курс.
- [x] **Создать файл `src/course/api/routes.ts`**.
- [x] **Вырезать логику обработки эндпоинтов (`/api/track`, `/api/submit-form`, `/api/chat`) из старого `server.ts` и вставить её в `src/course/api/routes.ts`**. Это изолирует API курсов от ядра сервера.

### Фаза 4: Создание заглушки для модуля `community`

- [x] Создать базовый `src/community/ui/index.html` с текстом "Главная страница IT-сообщества".
- [x] Создать пустые `src/community/api/routes.ts` и `src/community/ui/main.ts` как заготовки для будущей функциональности.

### Фаза 5: Рефакторинг и адаптация кода

- [x] **`app/server.ts`**: Отрефакторить для импорта и регистрации роутов из `course/api/routes.ts` и `community/api/routes.ts`. Вся специфичная логика обработки запросов должна быть удалена из этого файла. Также необходимо обновить пути для раздачи статики.
- [x] **`build.ts`**: Полностью переработать для поддержки модульной структуры. Скрипт должен уметь находить UI-директории в каждом модуле (`app`, `course`, `community`) и корректно собирать все точки входа (`entrypoints`) и HTML-файлы.
- [x] **`tsconfig.json`**: Добавить `paths` aliases для удобства импортов между модулями (например, `@app/*`, `@course/*`). Это позволит избежать относительных путей (`../../../`).
- [x] **Обновить импорты**: Пройтись по всем перемещенным файлам и исправить пути импортов в соответствии с новой структурой и (после настройки) с использованием `paths` aliases.

### Фаза 6: Верификация

- [x] Запустить `bun run build:dev`. Сборка должна пройти без ошибок.
- [ ] Запустить `bun run start:dev`. Сервер должен запуститься без ошибок.
- [ ] Проверить в браузере, что главная страница (`/`) отдает `community/index.html`.
- [ ] Проверить, что страницы курсов (например, `/course/index` или `/course/details`) корректно открываются и вся функциональность (трекинг, чат, форма) работает.
- [ ] Запустить тесты (`bun test`), чтобы убедиться, что ничего не сломалось.
